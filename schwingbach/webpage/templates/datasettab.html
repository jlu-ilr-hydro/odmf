<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/">

<head>
	
	<link href="/media/iconilr.css" rel="stylesheet" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>${title}</title>
	<link href="/media/jquery-ui-1.8.18.custom.css" rel="stylesheet" type="text/css"/>
    <script src="/media/jquery-1.7.1.min.js" type="text/javascript" ></script>
    <script src="/media/jquery-ui-1.8.18.custom.min.js" type="text/javascript" ></script>
    <script>
    		//<![CDATA[
        $(function() {
        	$(".datepicker").datepicker({
        		maxDate:"0", dateFormat: 'dd.mm.yy' 
        	});
        	$('#tab').tabs();
					$('#tabheads a').click(function() {
						$('#title').html('Data sets (' + $(this).html() + ')');
					});

        	
        });
        function toggle(id) {
        	$('#' + id).slideToggle('fast');
        }
	  		function gotods() {
    			dsid = prompt('Goto dataset no.');
    			if (dsid>0) {
    				window.location.href='/dataset/' + dsid;
    			}
    		}

        function plotds(id) {	
        	var url = '/dataset/plot'
					        	+ '?id='+id
					        	+ '&' + 'start='+$('#plotstart').val()
					        	+ '&' + 'end='+$('#plotend').val()
					        	+ '&' + 'marker=' + $('#markerpicker').val()
					        	+ '&' + 'line=' + $('#linepicker').val()
					        	+ '&' + 'color=' + $('#colorpicker').val();
					$('#plotimg').attr('src',url);
        }
				function remove(dsid,dsname,reccount) {
					var msg = 'Are you absolutly sure to delete ' + dsname + '?' +
					          'It has ' + reccount + ' records!' 
					var really=confirm(msg)
					if (really) {
						$.post('/dataset/remove/' + dsid, function(data) {
							if (data) {
								$('.error').html(data);
							} else {
								window.back();
							}
						});
					}
				}
				function loadsplitrecords(datasetid) {
					var threshold = $('#splitthreshold').val();
					$('#splitrecords').load('/dataset/findsplitpoints',
																		{datasetid:datasetid,threshold:threshold});
				}
				
				//]]>
    </script>

	<style>
		/*input { width: 100%;}
		select { width: 100%;}*/
		.bold {
			font-weight: bold;
		}
		a.toggle {
			display: block; 			
		}
		span.nobreak {
			white-space: nowrap;
		}
		#tab {
			background-color: white;
			border:solid 1px #3D578C;

		}
		#tab > div {
			background-color: white;
		}
		.ui-tabs .ui-tabs-nav li a {
			padding: 0px 1em;
			font-size: small;
		}
		.leftspace {
			margin-left: 2em;
		}
			
	</style>
</head>
<!--
	Input variables:
	error - string
	activedataset - Dataset
	session
	db - module 
-->
<body>
	${navigation('Data sets')}
  <div class="content">
	  <div class="error" py:content="error" />
		<a href="/dataset">Go to list...</a><a href="javascript:gotods();" tabindex="1" class="leftspace">&#x25B6;goto dataset...</a>
		<div py:if="activedataset" py:with="mean,std,n=activedataset.statistics()">
			<h2 py:content="'#%i %s (%s-%s)' % (activedataset.id,activedataset.name,formatdate(activedataset.start),formatdate(activedataset.end))" />	
			<div id="description">
				<table>
					<tr py:if="activedataset.valuetype">
						<td class="bold">Data:</td>
						<td><a href="/valuetype/${activedataset.valuetype.id}" py:content="activedataset.valuetype.name"/>
							<span py:if="activedataset.records.count()" >
											${'%0.4g' % mean} ${('&plusmn; %0.4g' % std) if std else ''} ${activedataset.valuetype.unit}, n=${n}
							</span>
						</td>
					</tr>
					<tr py:if="activedataset.site">
						<td class="bold">Site:</td>
						<td>
							<a href="/site/${activedataset.site.id}" py:content="activedataset.site" />
						</td>
					</tr>
					<tr>
						<td class="bold">Measured by:</td>
						<td>
							<a href="${'/user/%s' % (activedataset.measured_by.username if activedataset.measured_by else '')}">
								${activedataset.measured_by}
							</a>
						</td> 
					</tr>
					<tr>
						<td class="bold">Quality:</td>
						<td py:content="activedataset.quality" />
					</tr>
					<tr>
						<td class="bold">Data source:</td>
						<td py:content="activedataset.source" />
					</tr>
					<tr py:if="activedataset.quality and activedataset.quality.id>=3">
						<td class="bold">Calibration: </td>
						<td py:content="'v\' = %g * v + %g' % (activedataset.calibration_slope,activedataset.calibration_offset)" />
					</tr>
					<tr>
						<td class="bold">Comment:</td>
						<td>
							<div py:content="activedataset.comment" style="white-space: pre-line;"/>
						</td>
					</tr>
				</table>
			</div>
		</div>
	  <div py:if="activedataset" id="tab" py:with="mean,std,n=activedataset.statistics()">
	  	<ul id="tabheads">
	  		<li py:if="is_member('editor')"><a href="#edit">edit</a></li>
	  		<li><a href="#similar">similar</a></li>
	  		<li py:if="is_member('editor')"><a href="#records">records</a></li>	  		
	  		<li><a href="#plot">plot</a></li>
	  		<li py:if="is_member('editor') and activedataset.valuetype and std"><a href="#split">split</a></li>
	  		<li py:if="is_member('editor')"><a href="/dataset/calibration?targetid=${activedataset.id}">calibrate</a></li>
	  		<li py:if="is_member('logger')"><a href="#export">export</a></li>
	  	</ul> 
			<div id="edit" py:if="is_member('editor')">
				<form action="/dataset/saveitem" method="post">
					<input type="text" name="id" value="${activedataset.id}" style="display: none;" />
					<a py:if="is_member('admin') and activedataset.start"
							href="javascript:remove(${activedataset.id},'${str(activedataset)}',${activedataset.records.count()});">
						<img src="/media/minus-small.png" />remove dataset
					</a>
					<table style="width: 100%">
						<tr>
							<td>Name:</td>
							<td><input type="text" name="name" value="${activedataset.name}" /></td>
						</tr>
						<tr>
							<td><a href="${'/user/%s' % (activedataset.measured_by.username if activedataset.measured_by else '')}"> Measured by:</a></td>
							<td>
								<select name="measured_by">
									<option value=""><i>Please select...</i></option>
									<option py:for="p in session.query(db.Person).order_by('can_supervise DESC,surname')"
											py:attrs="markoption(p is activedataset.measured_by)"
											py:content="p"
											value="${p.username}" />
								</select>
							</td>
						</tr>
						<tr>
							<td><a href="${'/valuetype/%s' % (activedataset.valuetype.id if activedataset.valuetype else '')}">Value:</a></td>
							<td>
								<select name="valuetype">
									<option value=""><i>Please select...</i></option>
									<option py:for="vt in session.query(db.ValueType).order_by(db.ValueType.name)"
											py:attrs="markoption(vt is activedataset.valuetype)"
											py:content="vt"
											value="${vt.id}" />
								</select>
							</td>
						</tr>
						<tr>
							<td><a href="${'/site/%s' % (activedataset.site.id if activedataset.site else '')}">Site:</a></td>
							<td>
								<select name="site">
									<option value=""><i>Please select...</i></option>
									<option py:for="s in session.query(db.Site).order_by(db.Site.id)"
											py:attrs="markoption(s is activedataset.site)"
											py:content="s"
											value="${s.id}" />
								</select>
							</td>
						</tr>
						<tr>
							<td>Quality:</td>
							<td>
								<select name="quality">
									<option value=""><i>Please select...</i></option>
									<option py:for="q in session.query(db.Quality)"
											py:attrs="markoption(q is activedataset.quality)"
											py:content="q"
											value="${q.id}" />
								</select>
							</td>
						</tr>
						<tr>
							<td style="width: 7em">From (date):</td>
							<td><input type="text" class="datepicker" name="start" value="${formatdate(activedataset.start)}" /></td>
						</tr>
						<tr>
							<td>Until (Datum):</td>
							<td><input type="text" class="datepicker" name="end" value="${formatdate(activedataset.end)}" /></td>
						</tr>
						<tr>
							<td>Data source (eg. instrument):</td>
							<td>
								<select name="source">
									<option value=""><i>Please select...</i></option>
									<option py:for="datasource in session.query(db.Datasource)"
											py:attrs="markoption(datasource is activedataset.source)"
											py:content="datasource"
											value="${datasource.id}" />
								</select>
							</td>
						</tr>
						<tr>
							<td>
								<a href="/dataset/calibration?targetid=${activedataset.id}">Calibrate</a>: 
							</td>
							<td>
								v' = <input type="text" value="${activedataset.calibration_slope}" name="calibration_slope" size="5" style="text-align: right;" />
								* v + <input type="text" value="${activedataset.calibration_offset}" name="calibration_offset" size="5" style="text-align: right;"/>
							</td>
						</tr>
						<tr>
							<td>Comments</td>
							<td>
								<p>
									The database is still under construction. Please insert instrument type and other meta data
									in the comment.
								</p>
								<textarea name="comment" 
									  style="width: 100%;"
									  rows="10" 
									  py:content="activedataset.comment" />
							</td>
						</tr>
					</table>
					<input type="submit" name="save"  style="width: 10em;"/>						
				</form>
			</div>
			<div id="plot" >
				<button onclick="plotds(${activedataset.id});">Plot</button>
	
				from:
				<input type="text" class="datepicker" id="plotstart" value="${formatdate(activedataset.start)}"/>
				until:
				<input type="text" class="datepicker" id="plotend" value="${formatdate(activedataset.end)}"/>
				marker:
				<select id="markerpicker">
					<option value="">none</option>
					<option value="x">x</option>
					<option value="o">o</option>
					<option value=".">.</option>
					<option value="|">x</option>
					<option value="+">+</option>
					<option value="*">*</option>
				</select>
				line:
				<select id="linepicker">
					<option value="-">-</option>
					<option value="">none</option>
					<option value=":">:</option>
					<option value="--">--</option>
					<option value="-.">-.</option>
				</select>
				color:
				<select id="colorpicker">
					<option value="k" style="background-color: #000;">k</option>
					<option value="b" style="background-color: #00F;">b</option>
					<option value="g" style="background-color: #0F0;">g</option>
					<option value="r" style="background-color: #F00;">r</option>
					<option value="y" style="background-color: #FF0;">y</option>
					<option value="c" style="background-color: #0FF;">c</option>
					<option value="m" style="background-color: #F0F;">m</option>
		
				</select>
		
				<div>
					<img id="plotimg" alt="" src=""/>
				</div>
			</div>
			<div id="split" py:if="is_member('editor') and activedataset.valuetype and std" >
				Threshold:<input id="splitthreshold" type="text" value="${'%0.3g' % std}" style="text-align: right;" />${activedataset.valuetype.unit}
				<input type="button" onclick="loadsplitrecords(${activedataset.id});" value="Find"/>
				<div id="splitrecords" />
			</div>
			<div id="similar">		
				<div py:for="dsname in datasets" >
					<h3>${dsname}</h3>
					<div id="${dsname.replace(' ','_')}">
						<ul style="list-style-image: url(/media/shimmer/document_16.png)">
							<li py:for="ds in datasets[dsname]">
								<a href="${ds.id}">${ds}</a>
							</li>
								
						</ul>
					</div>
				</div>
			</div>
			<div id="records" class="small" py:if="is_member('editor') and activedataset">
				min.&nbsp;date=&nbsp;<input type="text" id="recordmindate" class="datepicker" size="10"/>&nbsp;<input type="text" id="recordmintime" size="5" />			
				max.&nbsp;date=&nbsp;<input type="text" id="recordmaxdate" class="datepicker" size="10"/>&nbsp;<input type="text" id="recordmaxtime" size="5" />
				min.&nbsp;value=&nbsp;<input type="text" id="recordminvalue"/>
				max.&nbsp;value=&nbsp;<input type="text" id="recordmaxvalue"/>
				<script>
					function loadrecords() {
						var params={dataset:${activedataset.id},
												mindate:$('#recordmindate').val() + ' ' + $('#recordmintime').val(),
												maxdate:$('#recordmaxdate').val() + ' ' + $('#recordmaxtime').val(),
												minvalue:$('#recordminvalue').val(),
												maxvalue:$('#recordmaxvalue').val()
												};
						$('#recordlist').load('/dataset/records',params);
					}
				</script>
				<button onclick="loadrecords();">find records</button>
				<div id="recordlist"/>
			</div>
			<div id="export" py:if="is_member('logger')">
				<ul>
					<li py:if="activedataset">
					<button onclick="window.location='/dataset/records.csv?dataset=${activedataset.id}';">Export as CSV</button>
						Get Values as csv-file. Open with Excel if English language settings are chosen in Windows.				
					</li>
					<li>
						<a href="/datafiles/daten-vorlage.xls" style="float:left;">
							<img src="/media/excel-icon.gif" />
						</a>
						Download the excel template for data import
						<a href="/datafiles/dataset-xxxx.xls">here</a>.				
					</li>
				</ul>
			</div>  	
		</div>

  </div>

</body>
</html>
