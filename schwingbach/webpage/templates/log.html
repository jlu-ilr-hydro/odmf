<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/">

<head>
	<link href="/media/iconilr.css" rel="stylesheet" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link href="/media/jquery-ui-1.8.18.custom.css" rel="stylesheet" type="text/css"/>
  <script src="/media/jquery-1.7.1.min.js" type="text/javascript" />
  <script src="/media/jquery-ui-1.8.18.custom.min.js" type="text/javascript" />
  <script>
	function setmsg(text,label) {
		$('#message').text(text);
		$('#msghint').html(label);
	}
	
	function formatiso(isostr) { //from http://dev.enekoalonso.com/2010/09/21/date-from-iso-8601-string/
		var parts = isostr.match(/\d+/g);
		return parts[2] + '.' + parts[1] + '.' + parts[0];
	}

	function listlogs() {
		until=$('#lastlogdate').val();
		days=$('#days').val();
		$.getJSON('/log/json',{new:until, days:days}, function(data) {
			html='';
			templ='<li><a href="#href#">#text#</a></li>';
			$.each(data,function(index,item) {
				//.format('dd.mm.yyyy')
				text=formatiso(item.time)+': ' 
					+ item.message + ' at site#'+item.site.id
					+' ('+item.user.firstname + ' ' + item.user.surname + ')';
				html+=templ.replace(/#href#/,'/log/'+item.id).replace(/#text#/,text);
			});
			$('#loglist').html(html);
		});
	}
	$(function() {
		$(".datepicker").datepicker({maxDate:"0", dateFormat: 'dd.mm.yy' });
		listlogs(null,30);
	});
  </script>


	<title>Log</title>
	<style type="text/css">
  	   .msghint {
  	   	font-weight: bold;
  	   	color: red;
  	   }

	</style>	
</head>
<body onload="initialize()">
	${navigation()}
	<h1>Logbook</h1>

	<form action="/log/saveitem" method="post">
		<div py:if="actuallog">
			<h2 py:content="'%s, %s' % (formatdate(actuallog.time),actuallog.user)" />

			<table style="width: 100%">
				<tr>
					<td>Id</td>
					<td><input name="id" value="${actuallog.id}" readonly="readonly" class="readonly"/></td>
				</tr>
				<tr>
					<td><a href="/user/${actuallog.user}">Who?</a></td>
					<td>
						<select name="user">
							<option py:for="p in session.query(db.Person)"
									py:attrs="markoption(p is actuallog.user)"
									py:content="p"
									value="${p.username}" />
						</select>
					</td>
				</tr>
				<tr>
					<td>When?</td>
					<td>
						<input name="date" class="datepicker" value="${formatdate(actuallog.time)}"/>
					</td>
				</tr>
				<tr>
					<td><a href="${'/site/%s' % (actuallog.site.id if actuallog.site else '')}">Where?</a></td>
					<td>
						<select name="site">
							<option value=""><i> &lt;Bitte w√§hlen&gt;</i></option>
							<option py:for="s in session.query(db.Site).order_by(db.Site.id)"
									py:attrs="markoption(s is actuallog.site)"
									py:content="s"
									value="${s.id}" />
						</select>
					</td>
				</tr>
				<tr>
					<td />
					<td py:content="actuallog.site.comment if actuallog.site else ''" />
				</tr>
				<tr>
					<td>Note!</td>
					<td>
						<div class="msghint" id="msghint" /> 
					</td>
				</tr>
				<tr>
					<td>What?</td>
					<td>
						<input type="button" name="msgbutton1" value="sample taken"
							 onclick="setmsg('sample taken','Report time and water level/discharge (if applicable) to your message');" />
						<input type="button" name="msgbutton2" value="logger exchange"
							onclick="setmsg('logger exchange','Report time and water level/discharge (if applicable) to your message');" />
						<br />
						<textarea name="message" id="message"
								  style="width: 100%;"
								  rows="10" py:content="actuallog.message" />
					</td>
				</tr>
			</table>
		</div>
		<input type="submit" name="save" value="Speichern" style="width: 10em;"/>
	</form>
	<div>
		<h2>Log book</h2>
		Log book until
		<input id="lastlogdate" type="text" class="datepicker" value="${formatdate()}" onchange="listlogs();"/>
		for
		<select id="days" onchange="listlogs();">
			<option value="1">1</option>
			<option value="7">7</option>
			<option value="10">10</option>
			<option value="30" selected="selected">30</option>
			<option value="90">90</option>
		</select>
		days
		<button onclick="listlogs();">go</button>
		<ul id="loglist">
		</ul>
	</div>
</body>
</html>
