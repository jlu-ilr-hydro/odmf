<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/">

<head>
	<link href="/media/iconilr.css" rel="stylesheet" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link href="/media/jquery-ui-1.8.18.custom.css" rel="stylesheet" type="text/css"/>
  <script src="/media/jquery-1.7.1.min.js" type="text/javascript" />
  <script src="/media/jquery-ui-1.8.18.custom.min.js" type="text/javascript" />
  <script>
	function setmsg(text,label) {
		$('#message').text(text);
		$('#msghint').html(label);
	}
	
	function formatiso(isostr) { //from http://dev.enekoalonso.com/2010/09/21/date-from-iso-8601-string/
		var parts = isostr.match(/\d+/g);
		return parts[2] + '.' + parts[1] + '.' + parts[0];
	}
	function toggle(id) {
  	var obj = $('#'+id) 
  	if (obj.css('display')=='none') {
  		obj.css('display','inline');
  	} else {
  		obj.css('display','none');
  	}
  }

	function listlogs() {
		until=$('#lastlogdate').val();
		days=$('#days').val();
		$.getJSON('/log/json',{until:until, days:days}, function(data) {
			html='';
			templ='<li><a href="#href#">#text#</a></li>';
			$.each(data,function(index,item) {
				text=formatiso(item.time)+': ' 
					+ item.message + ' at site#'+item.site.id
					+' ('+item.user.firstname + ' ' + item.user.surname + ')';
				html+=templ.replace(/#href#/,'/log/'+item.id).replace(/#text#/,text);
			});
			$('#loglist').html(html);
		});
	}
	function pastelogs() {
		var text = $('#pastebin').val();
		$.post('/log/fromclipboard',{paste: text},function(data,textStatus,jqHXR) {
			$('#pasteerror').html(data);
			listlogs();
		})
	}
	function remove(id) {
		check = confirm('Do you really want to delete this log?');
		if (check) {
			location.href = '/log/remove?id=' + id;
		}
	}
	$(function() {
		$(".datepicker").datepicker({maxDate:"0", dateFormat: 'dd.mm.yy' });
		listlogs(null,30);
	});
  </script>


	<title>Log</title>
	<style type="text/css">
  	   .msghint {
  	   	font-weight: bold;
  	   	color: red;
  	   }
  	   .loglist {
  	   	list-style-image: url(/media/shimmer/brush_24.png);
  	   }

	</style>	
</head>
<body onload="initialize()">
	${navigation('Logbook')}
	<div class="content">
		<div py:if="actuallog">
			<h2>
				<span py:content="formatdate(actuallog.time)" />
				(<a href="/user/${actuallog.user.username}" py:content="actuallog.user" />)
			</h2>
			<img src="/media/shimmer/brush_32.png" style="float: left; margin-top: 10px;"/>
			<ul style="list-style: none;">
				<li>
					Message: <span style="font-style: italic; font-weight: bold;" py:content="markdown(actuallog.message)" />	
				</li>
				<li py:if="actuallog.site">
					Site: <a href="/site/${actuallog.site.id}" py:content="actuallog.site" />						
				</li>
				<li py:if="not actuallog.site">
					Site: <span class="warning">Not set</span>						
				</li>
			</ul>					
		</div>
		<a href="javascript:toggle('logform')" py:if="is_member('logger')">Edit...</a>
		<form id="logform" action="/log/saveitem" method="post" py:if="is_member('logger')" style="display:${'none' if actuallog.site else 'block'};">
			<table style="width: 100%">
				<tr>
					<td>Id</td>
					<td><input name="id" value="${actuallog.id}" readonly="readonly" class="readonly"/></td>
				</tr>
				<tr>
					<td><a href="/user/${actuallog.user}">Who?</a></td>
					<td>
						<select name="user">
							<option py:for="p in session.query(db.Person)"
									py:attrs="markoption(p is actuallog.user)"
									py:content="p"
									value="${p.username}" />
						</select>
					</td>
				</tr>
				<tr>
					<td>When?</td>
					<td>
						<input name="date" class="datepicker" value="${formatdate(actuallog.time)}"/>
					</td>
				</tr>
				<tr>
					<td><a href="${'/site/%s' % (actuallog.site.id if actuallog.site else '')}">Where?</a></td>
					<td>
						<select name="site">
							<option value=""><i>&lt;Please select...&gt;</i></option>
							<option py:for="s in session.query(db.Site).order_by(db.Site.id)"
									py:attrs="markoption(s is actuallog.site)"
									py:content="s"
									value="${s.id}" />
						</select>
					</td>
				</tr>
				<tr>
					<td />
					<td py:content="actuallog.site.comment if actuallog.site else ''" />
				</tr>
				<tr>
					<td>Note!</td>
					<td>
						<div class="msghint" id="msghint" /> 
					</td>
				</tr>
				<tr>
					<td>What?</td>
					<td>
						<textarea name="message" id="message"
								  style="width: 100%;"
								  rows="10" py:content="actuallog.message" />
					</td>
				</tr>
			</table>
		<input py:if="is_member('logger')" type="submit" name="save" value="Save..." style="width: 10em;"/>
			
		</form>

		<ul>
			<li style="list-style-image:url(/media/minus-small.png);" py:if="is_member('supervisor') and actuallog" >
				<a href="javascript:remove(${actuallog.id})">Remove log...</a>
			</li>
			<li style="list-style-image:url(/media/plus-small.png);" py:if="is_member('logger')" >
				<a href="/log/new">New log...</a>
			</li>
			<li style="list-style-image:url(/media/plus-small.png);" py:if="is_member('logger')" >
				<a href="javascript:toggle('pastediv');">Paste logs</a>
				<div id="pastediv" style="display: none">
					<div>
						Paste logs from Excel here. The text from the clipboard needs to have the following structure:<br/>
						<code>Message|SiteID|Date</code> (| means tab)<br />
						<div id="pasteerror" class="error"></div>
						<textarea id="pastebin" rows="10" cols="50">Message	12	02.08.2012</textarea><br />
						
						<button onclick="pastelogs()">Create Logs</button>
					</div>
				</div>
			</li>
		</ul>

		<div>
			<h1>History</h1>
			Show Logbook until
			<input id="lastlogdate" type="text" class="datepicker" onchange="listlogs();"/>
			for
			<select id="days" onchange="listlogs();">
				<option value="1">1</option>
				<option value="7">7</option>
				<option value="10">10</option>
				<option value="30" selected="selected">30</option>
				<option value="90">90</option>
			</select>
			days
			<button onclick="listlogs();">go</button>
			<ul id="loglist" class="loglist">
			</ul>
		</div>
	</div>
</body>
</html>
