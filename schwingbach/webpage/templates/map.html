<html xmlns="http://www.w3.org/1999/xhtml">
<!--
TODO: Include filter for dataset.valuetype and dataset.measured_by. Move page home to /map/kml and use html-get
-->
<head>
	<link href="/media/iconilr.css" rel="stylesheet" type="text/css"/>
	<link href="/media/jquery-ui-1.8.18.custom.css" rel="stylesheet" type="text/css"/>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

	<title>Map</title>
	
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>	
	<script type="text/javascript" src="/media/jquery-1.7.1.min.js"></script> 
  <script src="/media/jquery-1.7.1.min.js" type="text/javascript" ></script>
  <script src="/media/jquery-ui-1.8.18.custom.min.js" type="text/javascript" ></script>
  <script src="/media/jquery.json-2.3.min.js" type="text/javascript"></script>

	<script type="text/javascript">
    function toggle(id) {
    	$('#'+id).slideToggle('fast');
    }
    function setpref(data) {
			$.ajaxSetup({ scriptCharset:"utf-8", 
                    contentType:"application/json; charset=utf-8" });
		  $.post('/preferences/update',$.toJSON(data),null,'json');    	
    }
		function savemappref() {
			var center = map.getCenter();
			var data = {item:'map',
				   			 	lat:center.lat(),
				   			 	lng:center.lng(),
				   			 	zoom:map.getZoom(),
				   			 	type:map.getMapTypeId()
				   			};
			setpref(data);
		}
		function map_mousemove(loc) {
			$('#coordinates').html(loc.toUrlValue());
		}
		function map_dblclick(loc) {
			var url = '/site/new';
			url += '?lat=' + loc.lat();
			url += '&lon=' + loc.lng();
			window.location.href = url; 
		}
		function clearmarker() {
			$.each(markers,function(index,marker) {
				marker.setMap(null);
			});
			markers.length = 0;			
		}
		function setmarkers(source,filter) {
			clearmarker();
			var selectionsymbol = new google.maps.MarkerImage('/media/mapicons/selection.png',
														new google.maps.Size(37,37),
														new google.maps.Point(0,0),
														new google.maps.Point(6,30));
	    $.getJSON(source,filter,function(data) {
	    	$.each(data,function(index,item) {
					if (!item.icon) {
						icon='unknown.png';
					} else {
						icon = item.icon;
					}
					
	    		var image = new google.maps.MarkerImage('/media/mapicons/' + icon,
					      new google.maps.Size(24, 24),
					      new google.maps.Point(0,0),
					      new google.maps.Point(0, 24));
		    	var marker = new google.maps.Marker(
		    		{
								position: new google.maps.LatLng(item.lat,item.lon),
	      				title:'#' + item.id + '(' + item.name + ')',
	      				map:map,
	      				icon:image,
	  				}
	  			);
	  			if (item.id == selectedmarker) {
	  				marker.setShadow(selectionsymbol);
	  			}
	  			(function(eventmarker,id){
		  			google.maps.event.addListener(marker,'click',function() {
							$('#infotext').load('/map/sitedescription/' + id, function(response, status, xhr) {
  							if (status == "error") {
    							var msg = "Sorry but there was an error: ";
    							$("#infotext").html(msg + xhr.status + " " + xhr.statusText);
  							}
							});
							selectedmarker = id;
		  				$.each(markers,function(index,item) {
		  					item.setShadow(null);
		  				});
		  				eventmarker.setShadow(selectionsymbol);
							setpref({site:id});
		  			});  				
	  			}(marker,item.id));
	  			markers.push(marker)
	    	});
	    });
						
		}
		
		function popSelect() {
			var vt = $('#vtselect').val()
			var user = $('#userselect').val()
			var date = $('#dateselect').val()
			$.getJSON('/dataset/attrjson',
								{ attribute:'valuetype',
								  user:user,
								  date:date
								},
								function(data){
									var html='<option class="firstoption" value="">Please select...</option>';
									$.each(data,function(index,item){
										html+='<option value="'+item.id+'">'+item.name+'</option>';
									});
									$('#vtselect').html(html).val(vt);
								}
			);
					
			$.getJSON('/dataset/attrjson',
								{ attribute:'measured_by',
									valuetype:vt,
								  date:date
								},
								function(data) {
									var html='<option class="firstoption" value="">Please select...</option>';
									$.each(data,function(index,item){
										html+='<option value="'+item.username+'">'+item.firstname+' '+item.surname+'</option>';
									});
									$('#userselect').html(html).val(user);
								}
			);
			$('#datasetsonly').html('yes')
			setmarkers('/dataset/attrjson',
									{attribute:'site',
									 valuetype:vt,
									 user:user,
									 date:date,
								});							
		}
		function clearFilter() {
			$('.filter').val('');
			$('#dateselect').val('');
			$('#allsites').val(true);
			popSelect();
			setmarkers('/map/sites',{});
			$('#datasetsonly').html('no')
		}
		function zoomToMarkers() {
			var latlngbounds = new google.maps.LatLngBounds();
			$.each(markers,function(index,item){
   				latlngbounds.extend(item.getPosition());
			});
			map.setCenter(latlngbounds.getCenter());
			map.fitBounds(latlngbounds); 
		}
		function createmap() {
 	    var latlng = new google.maps.LatLng(50.5, 8.55);
	    var mapOptions = {
	      zoom: 16,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.HYBRID
	    };
	    
	    var map=new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
	    google.maps.event.addListener(map,'dblclick',function(event) {
	    	map_dblclick(event.latLng);
	    });    
	    google.maps.event.addListener(map,'mousemove',function(event) {
	    	map_mousemove(event.latLng);
	    });    
	    return map
			
		}
		

    $(function() {
			$(".datepicker").datepicker({maxDate:"0", dateFormat: 'dd.mm.yy' });
	    map = createmap();
			selectedmarker = 0;
	    markers = [];
	    popSelect();
	    clearFilter();
	    $(window).unload(savemappref);
	    // Get map preferences 
 	    $.getJSON('/preferences',{},function(data){
 	    	map.setZoom(data.map.zoom);
 	    	map.setCenter(new google.maps.LatLng(data.map.lat,data.map.lng));
 	    	map.setMapTypeId(data.map.type); 	    	 
 	    	if (data.site) {
	 	    	$('#infotext').load('/map/sitedescription',{siteid:data.site}); 
	 	    	selectedmarker = data.site;
    		}
 	    });
    });
	    
	   
	</script>

	<style type="text/css">
	  #map_canvas { height: 100%; width: 100%; }
	  .wide {width: 100%;}
	  .filter {width: 100%;}
	  /*button {height: 64px;}*/
	  .firstoption {font-style: italic;color: grey;}
	</style>	
	
</head>
<body>
	${navigation()}
	<div class="content">
		<h1>Site map</h1>
		<table style="height: 90%; width: 100%;">
			<tr>
				<td width="25%" valign="top" style="overflow: scroll;">
					<div>
						<h2>Current location</h2>
						<div id="coordinates" >Not in map</div>
					</div>
					<div id="filter">
						<h2>Filter</h2>
						<table class="wide">
							<tr>
								<td>value type:</td>
								<td>
									<select id="vtselect" onchange="popSelect();" class="filter">
										<option class="firstoption" value=""><i>Please select...</i></option>
									</select>								
								</td>
							</tr>
							<tr>
								<td>user:</td>
								<td>
									<select id="userselect" onchange="popSelect();" class="filter">
										<option value=""><i>Please select...</i></option>
									</select>																	
								</td>
							</tr>
							<tr>
								<td>date:</td>
								<td>
									<input id="dateselect" type="text" class="datepicker filter" value=""  
												onchange="popSelect();" title="Show only sites with a dataset for this date"/>																	
								</td>
							</tr>
							<tr>
								<td>apply:</td>
								<td>
									<button onclick="popSelect();" title="Apply the filter"><img src="/media/filter_16.png" alt="set filter"/></button>
									<button onclick="clearFilter();" title="Clear filter and show all sites"><img src="/media/clearfilter_16.png" alt="clear filter"/></button>
									<button onclick="zoomToMarkers();" title="Show all sites"><img src="/media/shimmer/world_16.png"  alt="zoom to markers"/></button>
								</td>
							</tr>
							<tr>
								<td>only datasets:</td>
								<td id="datasetsonly" style="text-align: center;">no</td>
							</tr>
						</table>
								
				
					</div>
					<hr />
					<div id="infotext">No site selected</div>				
				</td>
				<td>
					<div id="map_canvas" style="width:100%; height:100%;" >Map</div>	
				</td>
			</tr>
		</table>
	</div>
</body>
</html>
