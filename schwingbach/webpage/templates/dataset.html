<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/">

<head>
	
	<link href="/media/iconilr.css" rel="stylesheet" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>${title}</title>
	<link href="/media/jquery-ui-1.8.18.custom.css" rel="stylesheet" type="text/css"/>
    <script src="/media/jquery-1.7.1.min.js" type="text/javascript" ></script>
    <script src="/media/jquery-ui-1.8.18.custom.min.js" type="text/javascript" ></script>
    <script>
        $(function() {$(".datepicker").datepicker({maxDate:"0", dateFormat: 'dd.mm.yy' });});
    		function popSelect() {
    			vt = $('#vtselect').val()
    			user = $('#userselect').val()
    			site = $('#siteselect').val()
    			date = $('#dateselect').val()
	    			$.getJSON('/dataset/attrjson',
	    								{ attribute:'valuetype',
	    								  user:user,
	    								  site:site,
	    								  date:date
	    								},
	    								function(data){
	    									var html='<option value="">Please select...</option>';
	    									$.each(data,function(index,item){
	    										html+='<option value="'+item.id+'">'+item.name+'</option>';
	    									});
	    									$('#vtselect').html(html).val(vt);
	    								}
	    			);
	    					
		  			$.getJSON('/dataset/attrjson',
	    								{ attribute:'measured_by',
	    									valuetype:vt,
	    								  site:site,
	    								  date:date
	    								},
	    								function(data){
	    									var html='<option value="">Please select...</option>';
	    									$.each(data,function(index,item){
	    										html+='<option value="'+item.username+'">'+item.firstname+' '+item.surname+'</option>';
	    									});
	    									$('#userselect').html(html).val(user);
	    								}
	    			);		

	    			$.getJSON('/dataset/attrjson',
	    								{ attribute:'site',
	    									valuetype:vt,
	    								  user:user,
	    								  date:date
	    								},
	    								function(data){
	    									var html='<option value="">Please select...</option>';
	    									$.each(data,function(index,item){
	    										html+='<option value="'+item.id+'">#'+item.id+' ('+item.name+')</option>';
	    									});
	    									$('#siteselect').html(html).val(site);
	    								}
	    			);	
	    			$.getJSON('/dataset/json',
	    								{ valuetype: vt,
	    									user:user,
	    									site:site,
	    									date:date,
	    								},
	    								function(data){
	    									var html='';
	    									//$.each(data,function(index,item){html+='<li><a href="/dataset/'+item.id+'">'+item.name+'</a></li>'});
	    									$.each(data,function(index,item){html+='<li><a onclick="editdataset('+item.id+')">'+item.name+'</a></li>'});
	    									$('#dslist').html(html);
	    								}
	    				
	    			);
	    			

    			
    		}
    		function clearfilter() {
    			$('.filter').val('')
    			$('#dateselect').val('')
    			popSelect();
    		}
    		function editdataset(dsid) {
    			$('#dsedit').load('/dataset/edit',{id:dsid});
    		}
    		$(function() {
    				$(".datepicker").datepicker({maxDate:"0", dateFormat: 'dd.mm.yy' });
	    			popSelect();
	   		});
    </script>

	<style>
		input { width: 100%;}
		select { width: 100%;}	
	</style>
</head>
<!--
	Input variables:
	error - string
	activedataset - Dataset
	session
	db - module 
-->
<body>
	${navigation()}
    <div class="error" py:content="error" />
	
	<h1>Data sets</h1>
	<a href="/dataset">Go to list...</a>

    <div > 
		<form action="/dataset/saveitem" method="post">

			<div py:if="activedataset">
				<h2 py:content="activedataset.name if activedataset.name else 'Neuer Datensatz'" />
				<table style="width: 100%">
					<tr visible="0">
						<td style="width: 7em">ID:</td>
						<td><input type="text" name="id" value="${activedataset.id}" readonly="readonly" class="readonly"/></td>
					</tr>
					<tr>
						<td>Name:</td>
						<td><input type="text" name="name" value="${activedataset.name}" /></td>
					</tr>
					<tr>
						<td>Values:</td>
						<td py:if="activedataset.records.count()" 
							class="highlight"
							py:content="Markup(u'%0.4g &plusmn; %0.4g %s, n=%i' % (session.query(db.sql.func.avg(db.Record.value)).filter(db.Record.dataset==activedataset).scalar(), 
																				  session.query(db.sql.func.stddev(db.Record.value)).filter(db.Record.dataset==activedataset).scalar(),
																				  activedataset.valuetype.unit,
																				  activedataset.records.count())
											)" 
						/>
							
					</tr>

					<tr>
						<td><a href="${'/user/%s' % (activedataset.measured_by.username if activedataset.measured_by else '')}"> Measured by:</a></td>
						<td>
							<select name="measured_by">
								<option value=""><i>Please select...</i></option>
								<option py:for="p in session.query(db.Person)"
										py:attrs="markoption(p is activedataset.measured_by)"
										py:content="p"
										value="${p.username}" />
							</select>
						</td>
					</tr>
					<tr>
						<td><a href="${'/valuetype/%s' % (activedataset.valuetype.id if activedataset.valuetype else '')}">Value:</a></td>
						<td>
							<select name="valuetype">
								<option value=""><i>Please select...</i></option>
								<option py:for="vt in session.query(db.ValueType).order_by(db.ValueType.name)"
										py:attrs="markoption(vt is activedataset.valuetype)"
										py:content="vt"
										value="${vt.id}" />
							</select>
						</td>
					</tr>
					<tr>
						<td><a href="${'/site/%s' % (activedataset.site.id if activedataset.site else '')}">Site:</a></td>
						<td>
							<select name="site">
								<option value=""><i>Please select...</i></option>
								<option py:for="s in session.query(db.Site).order_by(db.Site.id)"
										py:attrs="markoption(s is activedataset.site)"
										py:content="s"
										value="${s.id}" />
							</select>
						</td>
					</tr>
					<tr>
						<td>Quality:</td>
						<td>
							<select name="quality">
								<option value=""><i>Please select...</i></option>
								<option py:for="q in session.query(db.Quality)"
										py:attrs="markoption(q is activedataset.quality)"
										py:content="q"
										value="${q.id}" />
							</select>
						</td>
					</tr>
					<tr>
						<td style="width: 7em">From (date):</td>
						<td><input type="text" class="datepicker" name="start" value="${formatdate(activedataset.start)}" /></td>
					</tr>
					<tr>
						<td>Until (Datum):</td>
						<td><input type="text" class="datepicker" name="end" value="${formatdate(activedataset.end)}" /></td>
					</tr>
					<tr>
						<td>Data source (eg. instrument):</td>
						<td>
							<select name="source">
								<option value=""><i>Please select...</i></option>
								<option py:for="datasource in session.query(db.Datasource)"
										py:attrs="markoption(datasource is activedataset.source)"
										py:content="datasource"
										value="${datasource.id}" />
							</select>
						</td>
					</tr>
					<!--<tr>
						<td>Datengruppe:</td>
						<td>
							<select name="group">
								<option value=""><i>&lt;Keine Gruppe&gt;</i></option>
								<option py:for="group in activedataset.potential_groups(session)"
										py:attrs="markoption(group is activedataset.group)"
										py:content="group"
										value="${group.id}" />
							</select>
						</td>
					</tr>-->
					<tr>
						<td>Comments</td>
						<td>
							<p>
								The database is still under construction. Please insert instrument type and other meta data
								in the comment.
							</p>
							<textarea name="comment" 
								  style="width: 100%;"
								  rows="10" 
								  py:content="activedataset.comment" />
						</td>
					</tr>
				</table>
			</div>
			<input type="submit" name="save"  style="width: 10em;"/>						
			
		</form>				
	</div>
	<hl />
	<div>
		<a href="/datafiles/daten-vorlage.xls" style="float:left;">
			<img src="/media/excel-icon.gif" />
		</a>
		Download the excel template  
		<a href="/datafiles/daten-vorlage.xls">here</a>.
	</div>

</body>
</html>
