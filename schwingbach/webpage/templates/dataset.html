<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/">

<head>
	
	<link href="/media/iconilr.css" rel="stylesheet" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>${title}</title>
	<link href="/media/jquery-ui-1.8.18.custom.css" rel="stylesheet" type="text/css"/>
    <script src="/media/jquery-1.7.1.min.js" type="text/javascript" ></script>
    <script src="/media/jquery-ui-1.8.18.custom.min.js" type="text/javascript" ></script>
    <script>
        $(function() {
        	$(".datepicker").datepicker({
        		maxDate:"0", dateFormat: 'dd.mm.yy' 
        	});
        });
        function toggle(id) {
        	var obj = $('#'+id) 
        	if (obj.css('display')=='none') {
        		obj.css('display','block');
        	} else {
        		obj.css('display','none');
        	}
        }
        function plotds(id) {	
        	var url = '/dataset/plot'
					        	+ '?id='+id
					        	+ '&amp;' + 'start='+$('#plotstart').val()
					        	+ '&amp;' + 'end='+$('#plotend').val()
					        	+ '&amp;' + 'marker=' + $('#markerpicker').val()
					        	+ '&amp;' + 'line=' + $('#linepicker').val()
					        	+ '&amp;' + 'color=' + $('#colorpicker').val();
        	
					$('#plot').attr('src',url);
        }

    </script>

	<style>
		/*input { width: 100%;}
		select { width: 100%;}*/	
	</style>
</head>
<!--
	Input variables:
	error - string
	activedataset - Dataset
	session
	db - module 
-->
<body>
	${navigation()}
  <div class="content">
	  <div class="error" py:content="error" />
		<h1>Data sets</h1>
		<a href="/dataset">Go to list...</a>
	
	  <div py:if="activedataset"> 
			<div>
				<h2 py:content="'#%i %s (%s-%s)' % (activedataset.id,activedataset.name,formatdate(activedataset.start),formatdate(activedataset.end))" />
				Values:
				<span py:if="activedataset.records.count()" 
								class="highlight"
								py:content="Markup(u'%0.4g &plusmn; %0.4g %s, n=%i' % (session.query(db.sql.func.avg(db.Record.value)).filter(db.Record.dataset==activedataset).scalar(), 
																					  session.query(db.sql.func.stddev(db.Record.value)).filter(db.Record.dataset==activedataset).scalar(),
																					  activedataset.valuetype.unit,
																					  activedataset.records.count())
												)" 
							/>
				<br />
				<button onclick="toggle('edit')" >Edit dataset...</button>
					
				<div id="edit" style="display:none;">
					<form action="/dataset/saveitem" method="post" py:if="is_member('editor')">
					<input type="text" name="id" value="${activedataset.id}" style="display: none;" />
					<table style="width: 100%">
						<tr>
							<td>Name:</td>
							<td><input type="text" name="name" value="${activedataset.name}" /></td>
						</tr>
						<tr>
							<td><a href="${'/user/%s' % (activedataset.measured_by.username if activedataset.measured_by else '')}"> Measured by:</a></td>
							<td>
								<select name="measured_by">
									<option value=""><i>Please select...</i></option>
									<option py:for="p in session.query(db.Person)"
											py:attrs="markoption(p is activedataset.measured_by)"
											py:content="p"
											value="${p.username}" />
								</select>
							</td>
						</tr>
						<tr>
							<td><a href="${'/valuetype/%s' % (activedataset.valuetype.id if activedataset.valuetype else '')}">Value:</a></td>
							<td>
								<select name="valuetype">
									<option value=""><i>Please select...</i></option>
									<option py:for="vt in session.query(db.ValueType).order_by(db.ValueType.name)"
											py:attrs="markoption(vt is activedataset.valuetype)"
											py:content="vt"
											value="${vt.id}" />
								</select>
							</td>
						</tr>
						<tr>
							<td><a href="${'/site/%s' % (activedataset.site.id if activedataset.site else '')}">Site:</a></td>
							<td>
								<select name="site">
									<option value=""><i>Please select...</i></option>
									<option py:for="s in session.query(db.Site).order_by(db.Site.id)"
											py:attrs="markoption(s is activedataset.site)"
											py:content="s"
											value="${s.id}" />
								</select>
							</td>
						</tr>
						<tr>
							<td>Quality:</td>
							<td>
								<select name="quality">
									<option value=""><i>Please select...</i></option>
									<option py:for="q in session.query(db.Quality)"
											py:attrs="markoption(q is activedataset.quality)"
											py:content="q"
											value="${q.id}" />
								</select>
							</td>
						</tr>
						<tr>
							<td style="width: 7em">From (date):</td>
							<td><input type="text" class="datepicker" name="start" value="${formatdate(activedataset.start)}" /></td>
						</tr>
						<tr>
							<td>Until (Datum):</td>
							<td><input type="text" class="datepicker" name="end" value="${formatdate(activedataset.end)}" /></td>
						</tr>
						<tr>
							<td>Data source (eg. instrument):</td>
							<td>
								<select name="source">
									<option value=""><i>Please select...</i></option>
									<option py:for="datasource in session.query(db.Datasource)"
											py:attrs="markoption(datasource is activedataset.source)"
											py:content="datasource"
											value="${datasource.id}" />
								</select>
							</td>
						</tr>
						<tr>
							<td>Calibration: </td>
							<td>
								v' = <input type="text" value="${activedataset.calibration_slope}" name="calibration_slope" size="5" style="text-align: right;" />
								* v + <input type="text" value="${activedataset.calibration_offset}" name="calibration_offset" size="5" style="text-align: right;"/>
							</td>
						</tr>
						<!--<tr>
							<td>Datengruppe:</td>
							<td>
								<select name="group">
									<option value=""><i>&lt;Keine Gruppe&gt;</i></option>
									<option py:for="group in activedataset.potential_groups(session)"
											py:attrs="markoption(group is activedataset.group)"
											py:content="group"
											value="${group.id}" />
								</select>
							</td>
						</tr>-->
						<tr>
							<td>Comments</td>
							<td>
								<p>
									The database is still under construction. Please insert instrument type and other meta data
									in the comment.
								</p>
								<textarea name="comment" 
									  style="width: 100%;"
									  rows="10" 
									  py:content="activedataset.comment" />
							</td>
						</tr>
					</table>
					<input type="submit" name="save"  style="width: 10em;"/>						
					</form>
					<div py:if="not is_member('editor')">
						<table style="width: 100%">
							<tr>
								<td>Name:</td>
								<td py:content="activedataset.name" />
							</tr>
							<tr>
								<td><a href="${'/user/%s' % (activedataset.measured_by.username if activedataset.measured_by else '')}"> Measured by:</a></td>
								<td py:content="activedataset.measured_by" />
							</tr>
							<tr>
								<td><a href="${'/valuetype/%s' % (activedataset.valuetype.id if activedataset.valuetype else '')}">Value:</a></td>
								<td py:content="activedataset.valuetype" />
							</tr>
							<tr>
								<td><a href="${'/site/%s' % (activedataset.site.id if activedataset.site else '')}">Site:</a></td>
								<td py:content="activedataset.site" />
							</tr>
							<tr>
								<td>Quality:</td>
								<td py:content="activedataset.quality" />
							</tr>
							<tr>
								<td style="width: 7em">From (date):</td>
								<td py:content="formatdate(activedataset.start)" />
							</tr>
							<tr>
								<td>Until (Datum):</td>
								<td py:content="formatdate(activedataset.end)" />
							</tr>
							<tr>
								<td>Data source (eg. instrument):</td>
								<td py:content="activedataset.source" />
							</tr>
							<tr>
								<td>Calibration: </td>
								<td py:content="'v\' = %g * v + %g' % (activedataset.calibration_slope,activedataset.calibration_offset)" />
							</tr>
							<tr>
								<td>Comments:</td>
								<td py:content="activedataset.comment" />
							</tr>
						</table>
					</div>				
				</div>
			</div>
	
			<h2>Plot</h2>
			<button onclick="plotds(${activedataset.id});">Plot</button>

			from:
			<input type="text" class="datepicker" id="plotstart" value="${formatdate(activedataset.start)}"/>
			until:
			<input type="text" class="datepicker" id="plotend" value="${formatdate(activedataset.end)}"/>
			marker:
			<select id="markerpicker">
				<option value="">none</option>
				<option value="x">x</option>
				<option value="o">o</option>
				<option value=".">.</option>
				<option value="|">x</option>
				<option value="+">+</option>
				<option value="*">*</option>
			</select>
			line:
			<select id="linepicker">
				<option value="-">-</option>
				<option value="">none</option>
				<option value=":">:</option>
				<option value="--">--</option>
				<option value="-.">-.</option>
			</select>
			color:
			<select id="colorpicker">
				<option value="k" style="background-color: #000;">k</option>
				<option value="b" style="background-color: #00F;">b</option>
				<option value="g" style="background-color: #0F0;">g</option>
				<option value="r" style="background-color: #F00;">r</option>
				<option value="y" style="background-color: #FF0;">y</option>
				<option value="c" style="background-color: #0FF;">c</option>
				<option value="m" style="background-color: #F0F;">m</option>
	
			</select>
	
			<div>
				<img id="plot" alt=""/>
			</div>
			
		</div>
		<hr />
		<div py:if="is_member('logger')" >
			<h2>Im- and Export</h2>
			<ul>
				<li>
				<button onclick="window.location='/dataset/records.csv?dataset=${activedataset.id}';">Export as CSV</button>
					Get Values as csv-file. Open with Excel if English language settings are chosen in Windows.				
				</li>
				<li>
					<a href="/datafiles/daten-vorlage.xls" style="float:left;">
						<img src="/media/excel-icon.gif" />
					</a>
					Download the excel template for data import
					<a href="/datafiles/daten-vorlage.xls">here</a>.				
				</li>
			</ul>
		</div>  	
  </div>

</body>
</html>
