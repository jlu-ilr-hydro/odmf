<!DOCTYPE html>

<py:extends href="layout.html" xmlns:py="http://www.w3.org/1999/xhtml">
    <py:block name="scripts">
        <!-- insert additional scripts -->
        <script type="text/javascript" src="${conf.root_url}/media/js/site-filter.js"/>
        <script>
            // <![CDATA[
            $(() => {
                function makePages(data) {
                    let pages = Math.ceil(data.count / data.limit)
                    let options = ''
                    for (let i = 1; i <= pages; i++) {
                        options += '<option value="' + i + '">' + i + ' / ' + pages + '</option>'
                    }
                    $('#page').html(options).val(data.page)

                }
                function applyFilter(item) {

                    var filter = new SiteFilter(item).populate_form()

                    if ($('#limit').val()) {
                        filter.limit = +$('#limit').val()
                        filter.page = $('#page').val()
                    }

                    filter.apply((data) => {
                        let html = ''

                        $.each(data.sites, (index, site) => {
                            html += '<a class="list-group-item list-group-item-action w-100" href="${conf.root_url}/site/' + site.id + '">' +
                                '<i class="fas fa-map-marked me-4"></i><span class="me-4">#' + site.id + '</span>' + site.name + '</a>'
                        })
                        $('#site-list').html(html)
                        $('#site-list-count').html(data.count)
                        makePages(data)

                    })
                }
                function pageChange(e) {
                    let dir = $(e.target).data('dir');
                    let page = $('#page').val()
                    if (dir === '-' && page > 1) {
                        page--;
                    } else if (dir === '+' && page < $('#page option:last').val()) {
                        page++;
                    }
                    $('#page').val(page).trigger('change')
                }

                applyFilter('site-filter')
                $('.filter').on('change', applyFilter)
                $('.page').on('click', pageChange)
                $('#limit').on('change', applyFilter)
                $('#page').on('change', applyFilter)
                $('.export').on('click', event=>{
                  let filter = new SiteFilter();
                  filter.format=$(event.currentTarget).data('format')
                  window.location = 'export?' + $.param(filter)
                })

            })
            // ]]>
        </script>
    </py:block>
    <py:block name="style">
        <!-- insert additional styles -->
    </py:block>
    <py:block name="sidebar">
        <div class="mt-3 h3 alert alert-secondary">

            <i class="fas fa-filter me-2"/>Filter

        </div>
        <div id="filter" class="card card-body" >
            <py:include href="site/site-filter.html"/>
        </div>

    </py:block>
    <py:block name="content">
        <!-- insert main content -->

        <div class="container">
            <div id="title-area" class="container bg-dark text-white w-100 border rounded flexbox shadow mb-4" >
                <h2 class="display-4 me-8" >
                    Sites
                </h2>
                <div class="">
                    <span class="badge bg-primary rounded-pill" id="site-list-count">0</span>
                    sites
                </div>
            </div>
            <div class="container collapse border rounded bg-light p-2 mb-4" id="import">
                <h3>Import sites</h3>
                <hr/>
                <h4>Import tabular data</h4>
                <div>
                    When you import sites, note that the tabular data <strong>must</strong> have the columns
                    <code>name, lat, lon</code>. Lat and lon are the geographic coordinates on a WGS84 reference ellipsoid. 
                    Optionally the column names <code>height, icon, comment</code>
                    are used.
                </div>
                <h4>Import geojson data</h4>
                <div>
                    If you are importing geospatial data in geojson form, the projection
                    of the data <strong>must</strong> be given and translatable in WGS84 (EPSG:4326). Each feature
                    <strong>must</strong> have a <code>name</code> property. Optionally property names <code>height, icon, comment</code>
                    are used to describe the site and <code>strokewidth, strokecolor, strokeopacity, fillcolor, fillopacity</code>
                    can be given for the appearance of the geometry. GeoJSON files can be created with QGIS from most geospatial data, tutorials are simple to find with
                    common search machines, like this one: <a href="https://support.tygron.com/wiki/How_to_create_a_GeoJSON_in_QGIS">How_to_create_a_GeoJSON_in_QGIS</a>
                </div>
                <div py:if="not is_member(Level.supervisor)" class="alert alert-warning">
                    For bulk import of sites you need to have have ${Level.supervisor.name} level. 
                </div>
                <form method="post" action="bulk_import/" enctype="multipart/form-data"  py:if="is_member(Level.supervisor)">
                    <div class="row mt-3">
                        <label for="file" class="col-sm-3 col-form-label" >Site file:</label>
                        <div class="col-sm-8">
                            <input type="file" class="custom-file-input form-control" 
                                    name="sitefile" id="file" accept=".xlsx,.geojson,.csv,.parquet"/>
                        </div>
                        <div class="col-sm-1">
                            <button type="submit" class="btn btn-success"><i class="fas fa-check"/></button>
                        </div>
                    </div>
                </form>
                
                <form method="post" action="bulk_undo" py:if="is_member(Level.supervisor) and undos">
                    <hr/>
                    <h4>Undo your former site imports</h4>
                    <div class="alert alert-warning">You can only undo a bulk import, if no other object references the new sites, like datasets</div>
                    <div class="list-group">
                        <div py:for="undo in undos[:10]" class="list-group-item list-group-item-action">
                            <div class="d-flex">
                                <button type="submit" class="btn btn-danger shadow me-4" name="undofile" value="${undo.filename()}" data-bs-toggle="tooltip" title="delete all imported sites">
                                    <i class="fas fa-arrow-rotate-left"></i>
                                </button>
                                <div class="me-4 border rounded p-1">
                                    <div>${undo}</div>
                                    <div class="small">${formatdatetime(undo.time)} - by ${undo.user}</div>
                                </div>
                                <div class="border rounded p-1">
                                    <div py:content="f'{len(undo.keys)} {undo.tablename}s'"/>
                                    <div class="small" py:content="markdown(f'site:{min(undo.keys)} - site:{max(undo.keys)}')"/>
                                </div>

                            </div>


                        </div>
                    </div>
                </form>
            </div>
            <ul class="nav bg-light p-1 border mb-1 w-100">
                <li class="nav-item my-auto mx-3">
                    <div class="input-group">

                        <button class="btn btn-secondary page" data-dir="-" title="previous page">&lt;</button>
                        <select class="form-control form-select page" type="number" id="page" title="Page" >
                            <option value="1">1 / 1</option>
                        </select>
                        <button class="btn btn-secondary page" data-dir="+" title="next page">&gt;</button>
                        <select class="form-control" type="number" id="limit" value="20" title="sites per page">
                            <option value="${i}" py:for="i in [10, 20, 50, 100, 1000]" py:content="f'{i}/page'"/>
                        </select>

                    </div>
                </li>
                <li class="nav-item ms-1">
                    <a href="./new#edit" class="btn btn-success"><i class="fas fa-plus me-2"/>new site</a>
                </li>
                <li class="nav-item ms-1">
                    <a href="#import" id="toggleimport"  data-bs-toggle="collapse"
                       class="btn btn-secondary"
                       aria-haspopup="true" aria-expanded="false"
                    >
                        <i class="fas fa-file-import"/> import <i class="fas fa-caret-up"/>
                    </a>

                </li>
                <li class="nav-item dropdown ms-1">
                    <button id="toggleexport"  data-bs-toggle="dropdown"
                            class="btn btn-secondary dropdown-toggle"
                            aria-haspopup="true" aria-expanded="false"
                    >
                        <i class="fas fa-file-export"/> export
                    </button>
                    <div class="dropdown-menu" id="exportdiv" aria-labelledby="toggleexport">
                        <a class="dropdown-item export" data-format="xlsx">
                            <i class="fas fa-file-excel me-4"/> Excel
                        </a>
                        <a class="dropdown-item export" data-format="csv">
                            <i class="fas fa-file-csv me-4" /> CSV
                        </a>
                        <a class="dropdown-item export" data-format="tsv">
                            <i class="fas fa-file me-4" /> TSV
                        </a>
                        <a data-format="json" class="dropdown-item export">
                            <i class="fas fa-file-code me-4"/> JSON
                        </a>
                    </div>
                </li>

            </ul>

            <div class="list-group" id="site-list">
            </div>

        </div>
    </py:block>
</py:extends>
