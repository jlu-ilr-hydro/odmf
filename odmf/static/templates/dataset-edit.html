<!DOCTYPE html>

<py:extends href="layout.html" xmlns:py="">
    <py:block name="scripts">
        <script type="text/javascript" src="${conf.root_url}/media/js/dataset-edit.js"></script>
    </py:block>
    <py:block name="style">
        <!-- insert additional styles -->
        <style>
            #plot .input-group-text {
                min-width: 6rem;
            }
            div.value {
                text-align: right;
                font-style: italic;
            }
            div.std:before {
                content: "&plusmn;";
            }
        </style>
    </py:block>
    <py:block name="sidebar">
        <!-- insert sidebar content -->
        <div class="container-fluid">
            <div class="">
                <a href="${conf.root_url}/dataset/" class="btn btn-primary w-100 flexbox mb-1">
                    <span><i class="fas fa-arrow-left mr-1" /></span>
                    <span>list</span>
                    <span><i class="fas fa-list-ul mr-1"/></span>
                </a>
            </div>
            <div class="">
                <div class="input-group ">
                    <div class="input-group-prepend" >
                        <button class="btn btn-secondary" id="gotods-btn"
                        >
                            <i class="fas fa-rocket" />
                        </button>
                    </div>
                    <input class="form-control" type="text" id="goto" tabindex="1" placeholder="goto dataset-id"
                           title="Go directly to a dataset by entering the id" data-toggle="tooltip"/>
                </div>

            </div>
            <hr/>
            <div class="row">
                <div class="col">
                    <div class="nav flex-column nav-pills" role="tablist"  aria-orientation="vertical" id="tabs">
                        <a id="description-tab" class="nav-link ${['', 'active'][ds_act.is_defined()]} border-top" data-toggle="pill" href="#description">dataset</a>
                        <a id="edit-tab" class="nav-link ${['', 'active'][not ds_act.is_defined()]} border-top" data-toggle="pill" href="#edit"
                           py:if="access(Level.editor)"
                        >edit</a>

                        <a id="transforms-tab" class="nav-link flexbox border-top"
                           data-toggle="pill" href="#transforms"
                           py:if="ds_act.is_defined() and ds_act.is_transformed()"
                        >
                            transforms
                        </a>
                        <a id="plot-tab" class="nav-link flexbox border-top" data-toggle="pill"
                           py:if="access(Level.guest) and ds_act.is_defined()"
                           href="#plot"
                        >plot
                        </a>
                        <a id="records-tab" class="nav-link flexbox border-top" data-toggle="pill"
                           py:if="access(Level.editor) and ds_act.is_timeseries()"
                           href="#records">
                            records
                        </a>
                        <a id="calibrate-tab" class="nav-link flexbox border-top" data-toggle="pill"
                           py:if="access(Level.editor)"
                           href="#calibrate"

                        >
                            calibrate
                        </a>
                    </div>
                </div>

            </div>
            <hr/>
            <div class="" py:if="hasattr(ds_act, 'clone')">
                <a href="${conf.root_url}/dataset/new" class="btn btn-warning w-100 flexbox">
                    <span><i class="fas fa-clone mr-1" /></span>
                    <span>clone dataset</span>
                    <span><i class="fas fa-clipboard"/></span>
                </a>
            </div>

        </div>

    </py:block>
    <py:block name="content">
        <div class="container">
            <div id="title-row" class="row mt-2 w-100">
                <div class="container">
                    <div id="title-area" class="container bg-dark text-white row w-100 border rounded shadow" py:if="ds_act" py:with="n=ds_act.size()">
                        <div class="col-sm row">
                            <h2 class="display-3 col-sm">ds<span id="dsid" py:content="ds_act.id"/></h2>
                            <div class="col-sm">
                                <div class="badge bg-info text-bg-info " py:content="ds_act.get_access_level(users.current).name" />
                                <div class="" py:content="ds_act.project"/>
                            </div>
                        </div>

                        <div class="col-sm my-auto">
                            <h3 >
                                <span py:content="formatdate(ds_act.start)"/> -
                                <span py:content="formatdate(ds_act.end)"/>
                            </h3>
                            <h3 py:content="ds_act.name"/>



                        </div>
                        <div class="lead col-sm my-auto">
                            <a class="d-block text-white text-right" href="${f'{conf.root_url}/valuetype/{ds_act.valuetype.id}' if ds_act.valuetype else '#edit'}"
                               py:content="f'{ds_act.valuetype.name} [{ds_act.valuetype.unit}]' if ds_act.valuetype else '?'"/>
                            <a class="d-block text-white text-right" href="${f'{conf.root_url}/site/{ds_act.site.id}' if ds_act.site else '#edit'}"
                               py:content="ds_act.site"/>
                            <a class="d-block text-white text-right" href="${f'{conf.root_url}/person/{ds_act.measured_by.username}' if ds_act.measured_by else '#edit'}"
                               py:content="ds_act.measured_by"/>
                        </div>
                    </div>
                </div>
            </div>
            <div id="no-access-row" class="row mt-2 w-100">
                <div class="container">
                    <div class="container bg-warning row w-100 border rounded"  py:if="not access()">
                        <h4 class="col-lg-4">Sorry, ${user()}</h4>
                        <div class="lead col-lg-8">
                            This dataset is not available for you. Ask the owner to get access.
                        </div>
                    </div>

                </div>
            </div>

            <div id="tab-row" class="tab-content row w-100 mt-2">
                <div id="description" class="tab-pane mx-auto ${['', 'active'][ds_act.is_defined()]}" role="tabpanel" >
                    <table class="table mx-auto">
                        <tr>
                            <td class="bold">Project:</td>
                            <td py:with="prj=ds_act.project"><a py:if="prj" href="${f'{conf.root_url}/project/{prj.id}'}" py:content="prj.name"/></td>
                        </tr>
                        <tr>
                            <td class="bold">Type:</td>
                            <td>${ds_act.type}</td>
                        </tr>
                        <tr>
                            <td class="bold">Name:</td>
                            <td>${ds_act.name}</td>
                        </tr>
                        <tr py:if="ds_act.filename" >
                            <td class="bold">File</td>
                            <td>
                                <a py:if="ds_act.path" href="${ds_act.path.href}" py:content="ds_act.path.basename"/>
                                <div py:if="not ds_act.path" py:content="ds_act.filename"/>

                            </td>
                        </tr>
                        <tr id="desc_valuetype">
                            <td class="bold">Data:</td>
                            <td py:if="ds_act.valuetype">
                                <a href="${conf.root_url}/valuetype/${ds_act.valuetype.id}" class="tooltip">
                                    ${ds_act.valuetype.name}
                                    <span>${ds_act.valuetype.comment}</span>
                                </a>
                                <span id="statistics" >
                                    <span id="mean">?</span>
                                    &plusmn;
                                    <span id="std">?</span>
                                    ${ds_act.valuetype.unit if ds_act.valuetype else '?'},
                                    n=<span id="n">${n}</span>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="bold">Site:</td>
                            <td>
                                <a href="${conf.root_url}/site/${ds_act._site}" py:content="ds_act.site" />
                            </td>
                        </tr>
                        <tr>
                            <td class="bold">Responsible:</td>
                            <td>
                                <a href="${conf.root_url}+ '/user/' + (ds_act.measured_by.username if ds_act.measured_by else '')">
                                    ${ds_act.measured_by}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <td class="bold">Quality:</td>
                            <td py:content="ds_act.quality" />
                        </tr>
                        <tr>
                            <td class="bold">Data source:</td>
                            <td py:if="ds_act.source">
                                <a href="${conf.root_url}/instrument/${ds_act.source.id}" py:content="ds_act.source" />
                                <a py:if="ds_act.source.manuallink" href="${conf.root_url}/${ds_act.source.manuallink}" class="ml-4"
                                   title="Open manual for ${ds_act.source}" data-toggle="tooltip"
                                >
                                    <i class="fas fa-book-open"/>
                                </a>
                            </td>
                        </tr>
                        <tr id="desc-project">
                            <td class="bold">Project:</td>
                            <td py:if="ds_act.project">
                                <a href="${conf.root_url}/project/${ds_act.project.id}" py:content="ds_act.project.name"></a>
                            </td>
                        </tr>
                        <tr py:if="ds_act.is_timeseries() and ds_act.quality and ds_act.quality.id>=3">
                            <td class="bold">Calibration: </td>
                            <td py:content="'v\' = %g * v + %g' % (ds_act.calibration_slope,ds_act.calibration_offset)" />
                        </tr>
                        <tr py:if="ds_act.is_transformed()" id="transformation">
                            <td class="bold">Transformation:</td>
                            <td class="big">$~f(x)=${ds_act.latex}~$</td>
                        </tr>
                        <tr id="desc-comment">
                            <td class="bold">Comment:</td>
                            <td>
                                <div py:content="markdown(ds_act.comment)" style="white-space: pre-line;"/>
                            </td>
                        </tr>
                    </table>
                    <button py:if="ds_act.is_timeseries() and access(Level.editor)" id="create-transformation"
                            class="btn btn-outline-primary mr-2" data-toggle="tooltip"
                            title="Create a transformed dataset for this">
                        $~f(x)~$ transform
                    </button>

                </div>
                <div id="edit" class="tab-pane w-100 mr-4 ${['', 'active'][not ds_act.is_defined()]}" role="tabpanel" py:if="access(Level.editor)">
                    <form action="save" method="post">
                        <input type="hidden" name="id" value="${ds_act.id}"  />
                        <div class="container w-100">
                            <div id="edit-name-user-vt" class="form-row">
                                <div class="form-group col-lg">
                                    <label for="name">Name:</label>
                                    <input class="form-control" type="text" id="name" name="name"
                                           value="${ds_act.name}"/>
                                </div>
                                <div class="form-group col-lg">

                                    <label for="measured_by">Measured by:</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <a class="btn btn-outline-secondary"
                                               href="${conf.root_url}/user/${ds_act.measured_by.username}"
                                               title="Edit ${ds_act.measured_by.username}" data-toggle="tooltip"
                                            >
                                                <i class="fas fa-user"/>
                                            </a>
                                            <a class="btn btn-outline-secondary"
                                               href="${conf.root_url}/user/new"
                                               title="Add a new person" data-toggle="tooltip"
                                            >
                                                <i class="fas fa-plus"/>
                                            </a>
                                        </div>
                                        <select class="form-control select2 border-secondary" id="measured_by"
                                                name="measured_by" py:attrs="disabled(not access(Level.admin))">
                                            <option value="" disabled="disabled">Please select...</option>
                                            <option py:for="p in persons"
                                                    py:attrs="markoption(p is ds_act.measured_by)"
                                                    py:content="p"
                                                    value="${p.username}"/>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group col-lg">
                                    <label for="valuetype">Value type:</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <a class="btn btn-outline-secondary"
                                               href="${conf.root_url}/valuetype/${ds_act.valuetype.id if ds_act.valuetype else ''}"
                                               title="Edit ${ds_act.valuetype}" data-toggle="tooltip"
                                            >
                                                <i class="fas fa-ruler"/>
                                            </a>
                                            <a class="btn btn-outline-secondary"
                                               href="${conf.root_url}/valuetype/new"
                                               title="Add a new valuetype" data-toggle="tooltip"
                                            >
                                                <i class="fas fa-plus"/>
                                            </a>
                                        </div>
                                        <select class="form-control select2 border-secondary" id="valuetype" name="valuetype">
                                            <option value="" disabled="disabled">Please select...</option>
                                            <option py:for="vt in valuetypes"
                                                    py:attrs="markoption(vt is ds_act.valuetype)"
                                                    py:content="vt"
                                                    value="${vt.id}" />
                                        </select>

                                    </div>

                                </div>
                            </div>
                            <div id="edit-project-site-level" class="form-row">
                                <div class="form-group col-lg">
                                    <label for="project">
                                        Project
                                    </label>
                                    <select py:attrs="disabled(not access(Level.admin))" id="project" name="project" class="form-control">
                                        <option value="0" >No Project</option>
                                        <option value="${p.id}"
                                                py:for="p in projects"
                                                py:content="p.name"
                                                py:attrs="markoption(p == ds_act.project)"></option>
                                    </select>

                                </div>

                                <div class="form-group col-lg">
                                    <label for="site">Site:</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <a class="btn btn-outline-secondary"
                                               href="${conf.root_url}/site/${ds_act.site.id if ds_act.site else ''}"
                                               title="Edit ${ds_act.site}" data-toggle="tooltip"
                                            >
                                                <i class="fas fa-map-marker-alt"/>
                                            </a>
                                            <a class="btn btn-outline-secondary"
                                               href="${conf.root_url}/site/new"
                                               title="Add a new site" data-toggle="tooltip"
                                            >
                                                <i class="fas fa-plus"/>
                                            </a>
                                        </div>
                                        <select id="site" name="site" class="form-control border-secondary select2">
                                            <option value="" disabled="disabled">Please select...</option>
                                            <option py:for="s in sites"
                                                    py:attrs="markoption(s is ds_act.site)"
                                                    py:content="s"
                                                    value="${s.id}"/>
                                        </select></div>
                                </div>
                                <div class="form-group col-lg">
                                    <label for="level" data-toggle="tooltip"
                                           title="Measured level offset to site. Only for sites with multiple instruments in serveral depth. Use negative values for instruments below ground."
                                    >
                                        Level in m:
                                    </label>
                                    <input type="text" class="form-control" id="level" name="level" value="${formatfloat(ds_act.level,'%g')}"/>
                                </div>
                            </div>
                            <div id="edit-quality-source-access" class="form-row">
                                <div class="form-group col-lg">
                                    <label for="quality">Quality:</label>
                                    <select id="quality" name="quality" class="form-control">
                                        <option value="" disabled="disabled">Please select...</option>
                                        <option py:for="q in quality"
                                                py:attrs="markoption(q is ds_act.quality)"
                                                py:content="q"
                                                value="${q.id}"/>
                                    </select>
                                </div>
                                <div class="form-group col-lg">
                                    <label for="source">Data source (eg. instrument):</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <a class="btn btn-outline-secondary"
                                               href="${conf.root_url}/instrument/${ds_act.source.id if ds_act.source else ''}"
                                               title="Edit ${ds_act.source}" data-toggle="tooltip"
                                            >
                                                <i class="fas fa-thermometer-half"/>
                                            </a>
                                            <a class="btn btn-outline-secondary"
                                               href="${conf.root_url}/instrument/new"
                                               title="Add a new instrument" data-toggle="tooltip"
                                            >
                                                <i class="fas fa-plus"/>
                                            </a>
                                        </div>

                                        <select id="source" name="source" class="form-control select2 border-secondary">
                                            <option value="" disabled="disabled">Please select...</option>
                                            <option py:for="datasource in datasources"
                                                    py:attrs="markoption(datasource is ds_act.source)"
                                                    py:content="datasource"
                                                    value="${datasource.id}"/>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group col-lg">
                                    <label for="access" data-toggle="tooltip"
                                           title="Select the user level needed to see the content of the dataset. Default is logged in user">
                                        User level
                                    </label>
                                    <select id="access" name="access" class="form-control">
                                        <option value="0" py:attrs="markoption(ds_act.access==0)">Public dataset
                                        </option>
                                        <option value="1" py:attrs="markoption(ds_act.access==1)">Only known users
                                            (logger)
                                        </option>
                                        <option value="2" py:attrs="markoption(ds_act.access==2)">Only editing users
                                            (editor)
                                        </option>
                                        <option value="3" py:attrs="markoption(ds_act.access==3)">Only employees
                                            (supervisor)
                                        </option>
                                        <option value="4" py:attrs="markoption(ds_act.access==4)">Only administrators
                                            (admin)
                                        </option>
                                    </select>
                                </div>

                            </div>
                            <div id="edit-valid-dates" class="form-row" py:if="ds_act.is_timeseries()">
                                <div class="form-group col-lg">
                                    <label for="start">time range</label>
                                    <div class="input-group">
                                        <input type="date" class="form-control" id="start" name="start" value="${formatdate(ds_act.start, '%Y-%m-%d')}" />
                                        <div class="input-group-append">
                                            <span class="input-group-text px-2">-</span>
                                        </div>
                                        <input type="date" class="form-control" id="end" name="end" value="${formatdate(ds_act.end, '%Y-%m-%d')}" />
                                    </div>

                                </div>
                                <div class="form-group col-lg">
                                    <label for="timezone">
                                        Timezone
                                    </label>
                                    <select id="timezone" name="timezone" class="form-control select2">
                                        <option py:for="timezone in timezones"
                                                py:attrs="markoption(timezone == ds_act.timezone)"
                                                py:content="timezone"
                                                value="${timezone}"></option>
                                    </select>
                                </div>
                                <div class="form-group col-lg">
                                    <label for="calibration_slope">
                                        <a href="${conf.root_url}/dataset/calibration?targetid=${ds_act.id}">Calibration</a>:
                                    </label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$~x\prime = ~$</span>
                                        </div>
                                        <input class="form-control" type="text"
                                               value="${formatfloat(ds_act.calibration_slope)}" id="calibration_slope"
                                               name="calibration_slope" size="5" style="text-align: right;"/>
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$~\cdot\ x\ +\ ~$</span>
                                        </div>

                                        <input type="text" value="${formatfloat(ds_act.calibration_offset)}"
                                               class="form-control" id="calibration_offset" name="calibration_offset"
                                               size="5" style="text-align: right;"/>
                                    </div>
                                </div>
                            </div>
                            <div id="edit-transformation" class="form-row" py:if="ds_act.is_transformed()">

                                <div class="form-group col-lg" data-toggle="tooltip" data-placement="bottom"
                                     title="Please enter a valid Python/numpy expression for the transformation. See below for guidance">
                                    <label for="expression">Python:</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">
                                                $~f(x)=~$
                                            </span>
                                        </div>
                                        <input type="text" value="${ds_act.expression}" id="expression" name="expression" size="50" class="transhelpparent form-control"/>
                                    </div>
                                </div>
                                <div class="form-group col-lg" data-toggle="tooltip" data-placement="bottom"
                                     title="Please enter the latex description for the formula for printing">
                                    <label for="latex">Latex:</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">
                                                $~f(x)=~$
                                            </span>
                                        </div>
                                        <input type="text" value="${ds_act.latex}" id="latex" name="latex" size="50" class="form-control transhelpparent"/>

                                    </div>
                                </div>
                            </div>
                            <div class="form-row" py:if="ds_act.is_transformed()">
                                <div id="trans_help" class="card toggle">
                                    <div class="card-body">
                                        <h4 class="card-title">Some help for the Python and latex expressions</h4>
                                        Do not use any other variables in the expression than x (the values of the timeseries)
                                        <table class="table">
                                            <tr>
                                                <th>Equation type</th>
                                                <th>Example</th>
                                                <th>Python code</th>
                                                <th>Latex code</th>
                                            </tr>
                                            <tr>
                                                <td>Polynom</td>
                                                <td>$~-0.5\cdot10^{-5}x^3+2.35x^2-124.5x+15.3~$</td>
                                                <td>-0.5e-5*x**3 + 2.35*x**2 - 124.5*x + 15.3</td>
                                                <td>-0.5\dot10^{-5}x^3+2.35x^2-124.5x+15.3</td>
                                            </tr>
                                            <tr>
                                                <td>Exponential</td>
                                                <td>$~3.2 e^{0.5x}~$</td>
                                                <td>3.2 * exp(0.5*x)</td>
                                                <td>3.2 e^{0.5x}</td>
                                            </tr>
                                            <tr>
                                                <td>nat. log.</td>
                                                <td>$~\ln{x}~$</td>
                                                <td>log(x)</td>
                                                <td>\ln{x})</td>
                                            </tr>
                                            <tr>
                                                <td>dec. log.</td>
                                                <td>$~\log_{10}{x}~$</td>
                                                <td>log10(x)</td>
                                                <td>\log_{10}{x}</td>
                                            </tr>
                                            <tr>
                                                <td>cumulative sum</td>
                                                <td>\[\int_{t=0}^{t(x)}x dx\]</td>
                                                <td>cumsum(x)</td>
                                                <td>\int_{t=0}^{t(x)}x'dx</td>
                                            </tr>
                                        </table>
                                    </div>

                                </div>

                            </div>
                            <div class="form-row">
                                <label for="filename">filename</label>
                                <input id="filename" name="filename" class="form-control" type="text" value="${ds_act.filename}"/>
                            </div>
                            <div class="form-row">
                                <label for="comment">Comments:
                                </label>
                                <a title="Get help for using links and formats" data-toggle="tooltip" data-placement="top" class="ml-1 wiki-help" href="${conf.root_url}/help/odmf-markdown">
                                    <i class="fas fa-question-circle"/>
                                </a>

                                <textarea id="comment" name="comment"
                                          class="form-control"
                                          rows="10"
                                          py:content="ds_act.comment" />
                            </div>
                            <div id="edit-top-buttons" class="form-row mb-2">

                                <button type="submit" id="save" name="save" class="btn btn-success mr-2" >
                                    <i class="fas fa-check mr-2"/> save changes
                                </button>
                                <button py:if="access(Level.admin)" class="btn btn-danger mr-2"
                                        title="remove dataset permanently" data-toggle="tooltip" id="removeds"
                                        data-dsid="${ds_act.id}" data-dsname="${str(ds_act)}" data-dssize="${ds_act.size()}">
                                    <i class="fas fa-trash mr-2"/> delete dataset
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div id="transforms" class="tab-pane" role="tabpanel" py:if="ds_act.is_transformed()">
                    <h3>This data set transforms the records of the following <span py:content="len(ds_act.sources)"/> data sets:</h3>
                    <ul style="list-style:none;">
                        <li py:for="source in ds_act.sources" class="mb-1">
                            <button class="btn btn-danger btn-small mr-1"
                                    onclick="$.post(odmf_ref('/dataset/transform_removesource/'),{transid:${ds_act.id},sourceid:${source.id}},reload)"
                                    title="Remove source from transformation" data-toggle="tooltip"
                            >
                                &times;
                            </button>
                            <a class="ml-2" href="${source.id}" >
                                <span py:content="source" />
                                <span class="ml-2 badge badge-primary">${source.size()} records</span>
                            </a>
                        </li>
                        <li class="flexbox">
                            <button class="btn btn-success btn-small mr-1" id="trans_add_source"
                                    onclick="$.post(odmf_ref('/dataset/transform_addsource/'),{transid:${ds_act.id},sourceid:$('#trans_sources').val()},reload)"
                                    title="Adds the source for transformation" data-toggle="tooltip" disabled="disabled"
                            >
                                +
                            </button>
                            <select id="trans_sources" class="form-control ml-1">
                                <option value="" style="font-style: italic;" selected="selected">Please select</option>
                                <option py:for="potsrc in ds_act.suitablesources()" value="${potsrc.id}">${potsrc}</option>
                            </select>
                        </li>
                    </ul>
                </div>
                <div id="plot" class="tab-pane w-100 mr-4" role="tabpanel" py:if="users.current.level>=ds_act.access">
                    <div class="container mx-auto">
                        <div class="row">
                            <div class="col-xl input-group mb-1">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">from:</span>
                                </div>
                                <input type="date" class="form-control" id="plotstart" size="10"
                                       value="${formatdate(ds_act.start, '%Y-%m-%d')}"
                                />
                                <input type="text" class="form-control timepicker" id="plotstart_t" size="5"
                                       value="${formatdate(ds_act.start, '%H:%M')}"
                                />
                            </div>
                            <div class="col-xl input-group mb-1">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">until:</span>
                                </div>
                                <input type="date" class="form-control" id="plotend" size="10"
                                       value="${formatdate(ds_act.end + timedelta(days=1) if ds_act.end else ds_act.end, '%Y-%m-%d')}"
                                />
                                <input type="text" class="form-control timepicker" id="plotend_t" size="5"
                                       value="${formatdate(ds_act.end, '%H:%M')}"
                                />
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-lg input-group mb-1">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">marker:</span>
                                </div>

                                <select id="markerpicker" class="form-control">
                                    <option value="">none</option>
                                    <option value="x">x</option>
                                    <option value="o">o</option>
                                    <option value=".">.</option>
                                    <option value="|">x</option>
                                    <option value="+">+</option>
                                    <option value="*">*</option>
                                </select>
                                <div class="input-group-prepend">
                                    <span class="input-group-text">line:</span>
                                </div>
                                <select id="linepicker" class="form-control">
                                    <option value="-">-</option>
                                    <option value="">none</option>
                                    <option value=":">:</option>
                                    <option value="--">--</option>
                                    <option value="-.">-.</option>
                                </select>
                                <div class="input-group-prepend">
                                    <span class="input-group-text">color:</span>
                                </div>
                                <select id="colorpicker" class="form-control">
                                    <option value="k" style="background-color: #000;">k</option>
                                    <option value="b" style="background-color: #00F;">b</option>
                                    <option value="g" style="background-color: #0F0;">g</option>
                                    <option value="r" style="background-color: #F00;">r</option>
                                    <option value="y" style="background-color: #FF0;">y</option>
                                    <option value="c" style="background-color: #0FF;">c</option>
                                    <option value="m" style="background-color: #F0F;">m</option>

                                </select>
                            </div>

                        </div>
                        <div class="row">
                            <button class="btn btn-primary col-sm-3"
                                    onclick="plotds(${ds_act.id});">
                                <i class="fas fa-chart-line mr-1"/>plot
                            </button>
                            <div class="col-sm-3">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="interactive"/>
                                    <label class="custom-control-label" for="interactive">Make interactive plot</label>
                                </div>
                            </div>

                        </div>

                    </div>
                    <div id="plot-div">
                        <img id="plotimg" alt="" src=""/>
                    </div>

                </div>
                <div id="records" class="tab-pane" role="tabpanel"
                     py:if="ds_act.is_timeseries() and access(Level.editor)">
                    <div class="my-2">
                        <a href="#add-record-div" class="btn btn-primary dropdown-toggle" data-toggle="collapse"><i class="fas fa-plus-circle"/> new record</a>
                        <div id="add-record-div" class="border collapse mb-2 py-2">
                            <form id="add-record-form" action="${conf.root_url}/dataset/add-record" method="post">
                                <input type="hidden" name="dataset" value="${ds_act.id}" id="id-input" />
                                <div class="container w-100">
                                    <div class="form-group">
                                        <label for="add-record-value">value in ${ds_act.valuetype.unit if ds_act.valuetype else '?'}</label>
                                        <input id="add-record-value" type="number" name="value" class="form-control" step="any"/>
                                    </div>
                                    <div class="form-group">
                                        <label for="add-record-time">time</label>
                                        <input id="add-record-time" type="datetime-local" name="time" class="form-control datetime-local-now"/>
                                    </div>
                                    <div class="form-group">
                                        <label for="add-record-comment">comment</label>
                                        <input id="add-record-comment" type="text" name="comment"  class="form-control"/>
                                    </div>
                                    <button type="submit" class="btn btn-success"><i class="fas fa-check"/> add</button>

                                </div>

                            </form>
                        </div>
                    </div>
                    <div class="row w-100">
                        <div class="col-sm">
                            <button class="btn btn-primary w-100" id="find-records"><i class="fas fa-search"/> find records</button>
                        </div>
                        <div class="col-sm input-group" title="limit the number of records" data-toggle="tooltip">
                            <div class="input-group-prepend">
                                <span class="input-group-text">
                                    limit:
                                </span>
                            </div>
                            <input type="number" class="form-control" value="100" id="recordlimit"/>
                        </div>
                        <a href="#filter" class="col-sm dropdown-toggle btn btn-secondary dropdown-toggle " data-toggle="collapse" role="button">
                            <i class="fas fa-filter mr-2"/>Filter
                        </a>
                    </div>
                    <div class="alert alert primary collapse w-100" id="filter">
                        <div class="input-group mb-1">
                            <div class="input-group-prepend">
                                <span class="input-group-text">from:</span>
                            </div>
                            <input type="date" class="form-control" id="recordmindate" size="10"
                                   value="${formatdate(ds_act.start, '%Y-%m-%d')}"
                            />
                            <input type="text" class="form-control timepicker" id="recordmintime" size="5"
                                   value="${formatdate(ds_act.start, '%H:%M')}"
                            />
                        </div>
                        <div class="input-group mb-1">
                            <div class="input-group-prepend">
                                <span class="input-group-text">until:</span>
                            </div>
                            <input type="date" class="form-control" id="recordmaxdate" size="10"
                                   value="${formatdate(ds_act.end, '%Y-%m-%d')}"
                            />
                            <input type="text" class="form-control timepicker" id="recordmintime" size="5"
                                   value="${formatdate(ds_act.end, '%H:%M')}"
                            />
                        </div>
                        <div class="input-group mb-1">
                            <div class="input-group-prepend">
                                <span class="input-group-text" title="filter records that are in the given range" data-toggle="tooltip">range</span>
                            </div>
                            <input type="text" class="form-control" id="recordminvalue" placeholder="lower boundary" />
                            <input type="text" class="form-control" id="recordmaxvalue" placeholder="upper boundary" />
                            <div class="input-group-append">
                            <span class="input-group-text"
                                  py:content="ds_act.valuetype.unit if ds_act and ds_act.valuetype else '?'"
                            />
                            </div>

                        </div>
                        <div class="input-group mb-1">
                            <div class="input-group-prepend">
                                <span class="input-group-text">use jump size</span>
                                <span class="input-group-text">
                                <input type="checkbox" id="splitUseThreshold"/>
                            </span>
                            </div>
                            <input id="splitthreshold" class="form-control"
                                   type="text" value="0.0" />
                            <div class="input-group-append">
                            <span class="input-group-text"
                                  py:content="ds_act.valuetype.unit if ds_act and ds_act.valuetype else '?'"
                            />
                            </div>
                        </div>
                    </div>
                    <div class="row w-100 my-1">
                        <div class="container" id="recordlist"/>
                    </div>

                </div>
                <div id="calibrate" class="tab-pane" role="tabpanel"
                     py:if="ds_act.is_timeseries() and access(Level.editor)">
                    <div class="row">
                        <div class="col-sm-11">
                            <div class="input-group">
                                <div class="input-group-text">
                                    Calibrate from:
                                </div>
                                <select id="calibrate-select-source" class="form-control">
                                    <option value="" style="font-style: italic;">&lt;Please select...&gt;</option>
                                    <option py:for="ds in same_time_ds" value="${ds.id}"
                                            py:content="ds"/>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-1 text-right">
                            <button id="calibrate-button-start" class="btn btn-secondary ">
                                <i class="fas fa-redo mr-2"/>
                            </button>
                        </div>

                    </div>
                    <div id="calibrate-source-properties" class="mt-2 d-none">
                        <div class="row mt-2">
                            <div class="col-sm">
                                Records in timeseries:
                            </div>
                            <div class="col-sm ">
                                <div class="border border-rounded mx-1 p-1" id="calibrate-source-count">0</div>
                            </div>


                        </div>
                        <div class="row mt-2">

                            <div class="col-sm">Limit time error to:</div>
                            <div class="col-sm">
                                <input type="text" id="calibrate-limit-time-error" value="3600" class="form-control "/>
                            </div>
                        </div>
                    </div>
                    <div id="calibration-result" class="container mt-4 d-none">
                        <h3>Calibration results</h3>
                        <div class="">
                            <div class="border">
                                <div  class="row">
                                    <h4 class="col ml-2">Statistics</h4>
                                </div>
                                <div  class="row">
                                    <div class="col-6 text-right font-weight-bold" data-toggle="tooltip" title="Number or records in the source">n<sub>source</sub></div>
                                    <div id="calibration-result-count" class="col value">0</div>
                                    <div class="col"></div>
                                    <div class="col"></div>
                                </div>
                                <div class="row">
                                    <div class="col-6 text-right font-weight-bold">mean$~(x_{target})~$</div>
                                    <div id="calibration-result-target_mean" class="col value">0.0</div>
                                    <div id="calibration-result-target_std" class="col std">0.0</div>
                                    <div class="col unit">?</div>
                                </div>
                                <div class="row">
                                    <div class="col-6 text-right font-weight-bold">mean(x<sub>source</sub>)</div>
                                    <div id="calibration-result-source_mean" class="col value">0.0</div>
                                    <div id="calibration-result-source_std" class="col std">0.0</div>
                                    <div class="col unit">?</div>
                                </div>
                                <div class="row">
                                    <div class="col-6 text-right font-weight-bold">R&sup2; / RMSE</div>
                                    <div id="calibration-result-r2" class="col value" >0.0</div>
                                    <div id="calibration-result-rmse" class="col value">0.0</div>
                                    <div class="col unit">?</div>
                                </div>
                            </div>
                            <div class="border">
                                <div class="row mt-2">
                                    <h4 class="col ml-2">Linear regression $~y=a \cdot x + b~$</h4>
                                    <div class="col text-right mr-2">
                                        <button id="calibrate-apply-regression" class="btn btn-primary do-calibration"><i class="fas fa-check-circle mr-2"/>apply</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6 text-right font-weight-bold">slope $~a~$</div>
                                    <div id="calibration-result-slope" class="col value" >0.0</div>
                                    <div class="col unit">?</div>
                                    <div class="col"></div>
                                </div>
                                <div  class="row">
                                    <div class="col-6 text-right font-weight-bold">offset $~b~$</div>
                                    <div id="calibration-result-offset" class="col value" >0.0</div>
                                    <div class="col unit">?</div>
                                    <div class="col"></div>
                                </div>
                                <div  class="row">
                                    <div class="col-6 text-right font-weight-bold">RMSE</div>
                                    <div id="calibration-result-rmse_lr" class="col value" >0.0</div>
                                    <div class="col unit">?</div>
                                    <div class="col"></div>
                                </div>

                            </div>
                            <div class="border">
                                <div class="row mt-2">
                                    <h4 class="col ml-2">Bias correction $~y = x + c~$</h4>
                                    <div class="col text-right mr-2">
                                        <button id="calibrate-apply-offset" class="btn btn-primary do-calibration"><i class="fas fa-check-circle mr-2"/>apply</button>
                                    </div>
                                </div>
                                <div  class="row">
                                    <div class="col-6 text-right font-weight-bold">offset $~c~$</div>
                                    <div id="calibration-result-meanoffset" class="col value" >0.0</div>
                                    <div class="col unit">?</div>
                                    <div class="col"></div>

                                </div>
                                <div  class="row">
                                    <div class="col-6 text-right font-weight-bold">RMSE</div>
                                    <div id="calibration-result-rmse_off" class="col value" >0.0</div>
                                    <div class="col unit">?</div>
                                    <div class="col"></div>
                                </div>

                            </div>
                        </div>
                    </div>




                </div>
            </div>

        </div>
    </py:block>

</py:extends>
